{% extends 'base.html' %}
{% load static %}

{% block content %}
{% include 'components/navigation-bar.html' %}
<!-- Category Filter Navigation -->
<div class="bg-gray-200 py-20">
    <h1 class="text-center text-5xl font-bold font-serif">WISHLIST CATEGORIES</h1>
    <div class="carousel-container flex items-center justify-center mt-10">
        <div class="carousel-track w-[90%] h-[90%] overflow-hidden">
            <div class="carousel-items flex flex-wrap justify-center items-center py-2 transition-transform duration-300"> <!-- Change justify-start to justify-center -->
                <div data-category="all" class="wishlist-categories bg-white text-gray-700 py-3 px-5 rounded hover:bg-gray-300 m-2 min-w-[100px] flex items-center justify-center cursor-pointer">
                    All
                </div>
                {% for category in categories %}
                <div data-category="{{ category.id }}" class="wishlist-categories bg-white text-gray-700 py-3 px-5 rounded hover:bg-gray-300 m-2 min-w-[100px] flex items-center justify-center cursor-pointer">
                    {{category.name}}
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="toggle-button w-0 h-0 border-t-[24px] border-b-[24px] border-l-[16px] border-transparent border-l-black hover:border-l-gray-700 cursor-pointer" id="toggleButton"></div>
    </div>
</div>
<h1 class="text-center text-5xl font-bold font-serif mt-10">BRANDS</h1>
<div class="products"></div>
<h1 class="text-center text-5xl font-bold font-serif mt-10">RECOMMENDATIONS</h1>
<div class="recommend"></div>

<script>
   document.addEventListener("DOMContentLoaded", function () {
    const categoriesContainer = document.querySelector('.carousel-items');
    const toggleButton = document.getElementById('toggleButton');
    const carouselContainer = document.querySelector('.carousel-container');
    const categories = Array.from(categoriesContainer.children);
    const initialVisibleCount = 5;
    let isExpanded = false;
    let lastCarouselClicked = null;

    // Load initial categories
    const expandedState = localStorage.getItem('categoriesExpanded');
    if (expandedState === 'true') {
        isExpanded = true;
        categories.forEach(category => {
            category.style.display = 'flex';
        });
        carouselContainer.classList.add('mt-20');
    } else {
        showInitialCategories();
    }

    function showInitialCategories() {
        categories.forEach((category, index) => {
            category.style.display = (index < initialVisibleCount) ? 'flex' : 'none';
        });
    }

    function toggleCategories() {
        console.log("Toggle button clicked. Current state:", isExpanded);
        if (isExpanded) {
            console.log("Collapsing categories...");
            showInitialCategories();
            carouselContainer.classList.remove('mt-20');
            carouselContainer.classList.add('mt-10');
            toggleButton.style.borderLeftColor = 'black';
            localStorage.setItem('categoriesExpanded', 'false');
        } else {
            console.log("Expanding categories...");
            categories.forEach(category => {
                category.style.display = 'flex';
            });
            carouselContainer.classList.remove('mt-10');
            carouselContainer.classList.add('mt-20');
            toggleButton.style.borderLeftColor = 'gray';
            localStorage.setItem('categoriesExpanded', 'true');
        }
        isExpanded = !isExpanded;
    }

    toggleButton.addEventListener('click', toggleCategories);
    refreshStoresContent();

    async function refreshStoresContent(category = null) {
        let url = `/wishlist/filter/all`;

        if (category != null) {
            url = `/wishlist/filter/${category}`;
        }

        const response = await fetch(url);
        const text = await response.text();

        if (text){
            document.querySelector('.products').innerHTML = text;
            attachWishlistEventListeners();
        }

        refreshRecommendations();

        let index = 0;
        document.querySelectorAll('.store-images').forEach((item) => {
            index %= 8;
            item.setAttribute('src', `/static/images/store-default-${index}.jpg`);
            index++;
        });
    }

    document.querySelectorAll('.wishlist-categories').forEach((item) => {
        item.addEventListener('click', () => {
            lastCarouselClicked = item;
            refreshStoresContent(item.getAttribute('data-category'));
        });
    });

    async function refreshRecommendations() {
        const response = await fetch('/wishlist/recommended_wishlist/');
        const recommendedStoresHtml = await response.text();

        if (recommendedStoresHtml) {
        document.querySelector('.recommend').innerHTML = recommendedStoresHtml;
        attachWishlistEventListeners2(); 
        }

        document.querySelectorAll('.recommend-images').forEach((item) => {
            let randomInt = Math.floor(Math.random() * 8); 
            item.setAttribute('src', `/static/images/store-default-${randomInt}.jpg`);
        });
    }

    async function addWishlist(storeId) {
        try {
            const response = await fetch(`/wishlist/add/${storeId}/` , {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
            });
            await refreshStoresContent();
        } catch (error) {
            console.error('Error toggling wishlist:', error);
        }
    }

    async function removeWishlist(storeId) {
        try {
            const response = await fetch(`/wishlist/remove/${storeId}/` , {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
            });
            await refreshStoresContent();
        } catch (error) {
            console.error('Error toggling wishlist:', error);
        }
    }

    function attachWishlistEventListeners() {
        document.querySelectorAll('.wishlist-btn').forEach(button => {
            button.addEventListener('click', function () {
                const storeId = this.getAttribute('data-store-id');
                removeWishlist(storeId);
            });
        });
    }

    function attachWishlistEventListeners2() {
        document.querySelectorAll('.wishlist-btn2').forEach(button => {
            button.addEventListener('click', function () {
                const storeId = this.getAttribute('data-store-id');
                addWishlist(storeId);
            });
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
    
{% endblock %}